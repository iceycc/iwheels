!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("http"),require("superagent"),require("https"),require("assert"),require("util")):"function"==typeof define&&define.amd?define(["http","superagent","https","assert","util"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).$_supertest=e(t.http$1,t.superagent,t.https,t.assert,t.util)}(this,(function(t,e,s,r,n){"use strict";function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=o(t),c=o(s),a=o(r),u=o(n),h=i.default,p=h.METHODS&&h.METHODS.map((function(t){return t.toLowerCase()}))||["get","post","put","head","delete","options","trace","copy","lock","mkcol","move","purge","propfind","proppatch","unlock","report","mkactivity","checkout","merge","m-search","notify","subscribe","unsubscribe","patch","search","connect"];function d(t){const e=(new Error).stack.split("\n").slice(3);return function(s){const r=t(s);if(r instanceof Error&&r.stack){const t=r.stack.replace(r.message,"").split("\n").slice(1);r.stack=[r.toString()].concat(e).concat("--------").concat(t).join("\n")}return r}}function f(t,e,s){const r=new Error(t);return r.expected=e,r.actual=s,r.showDiff=!0,r}class l extends e.Request{constructor(t,e,s){super(e.toUpperCase(),s),this.redirects(0),this.app=t,this.url="string"==typeof t?t+s:this.serverAddress(t,s),this._asserts=[]}serverAddress(t,e){t.address()||(this._server=t.listen(0));const s=t.address().port;return`${t instanceof c.default.Server?"https":"http"}://127.0.0.1:${s}${e}`}expect(t,e,s){return"function"==typeof t?(this._asserts.push(d(t)),this):("function"==typeof e&&this.end(e),"function"==typeof s&&this.end(s),"number"==typeof t?(this._asserts.push(d(this._assertStatus.bind(this,t))),"function"!=typeof e&&arguments.length>1&&this._asserts.push(d(this._assertBody.bind(this,e))),this):"string"==typeof e||"number"==typeof e||e instanceof RegExp?(this._asserts.push(d(this._assertHeader.bind(this,{name:""+t,value:e}))),this):(this._asserts.push(d(this._assertBody.bind(this,t))),this))}end(t){const s=this,r=this._server;return e.Request.prototype.end.call(this,(function(e,n){if(r&&r._handle)return r.close(o);function o(){s.assert(e,n,t)}o()})),this}assert(t,e,s){const r={ECONNREFUSED:"Connection refused",ECONNRESET:"Connection reset by peer",EPIPE:"Broken pipe",ETIMEDOUT:"Operation timed out"};let n=null;!e&&t&&(n=t instanceof Error&&"connect"===t.syscall&&r[t.code]?new Error(t.code+": "+r[t.code]):t);for(let t=0;t<this._asserts.length&&!n;t++)n=this._assertFunction(this._asserts[t],e);n||!(t instanceof Error)||e&&t.status===e.status||(n=t),s.call(this,n||null,e)}_assertStatus(t,e){if(t!==e.status){const s=i.default.STATUS_CODES[t],r=i.default.STATUS_CODES[e.status];return new Error("expected "+t+' "'+s+'", got '+e.status+' "'+r+'"')}}_assertBody(t,e){const s=t instanceof RegExp;if("object"!=typeof t||s){if(t!==e.text){const r=u.default.inspect(t),n=u.default.inspect(e.text);if(!s)return f(`expected ${r} response body, got ${n}`,t,e.body);if(!t.test(e.text))return f("expected body "+n+" to match "+t,t,e.body)}}else try{a.default.deepStrictEqual(t,e.body)}catch(s){return f("expected "+u.default.inspect(t)+" response body, got "+u.default.inspect(e.body),t,e.body)}}_assertHeader(t,e){const s=t.name,r=e.header[s.toLowerCase()],n=t.value;return void 0===r?new Error('expected "'+s+'" header field'):Array.isArray(r)&&r.toString()===n||r===n?void 0:n instanceof RegExp?n.test(r)?void 0:new Error('expected "'+s+'" matching '+n+', got "'+r+'"'):new Error('expected "'+s+'" of "'+n+'", got "'+r+'"')}_assertFunction(t,e){let s;try{s=t(e)}catch(t){s=t}if(s instanceof Error)return s}}class y extends e.agent{constructor(t,s){super(),"function"==typeof t&&(t=i.default.createServer(t)),s&&(this._ca=s.ca,this._key=s.key,this._cert=s.cert),e.agent.call(this),this.app=t}host(t){return this._host=t,this}del(...t){this.delete(t)}}function _(t){const e={};return"function"==typeof t&&(t=i.default.createServer(t)),p.forEach((function(s){e[s]=function(e){return new l(t,s,e)}})),e.del=e.delete,e}return p.forEach((function(t){y.prototype[t]=function(e,s){const r=new l(this.app,t.toLowerCase(),e);return r.ca(this._ca),r.key(this._key),r.cert(this._cert),this._host&&r.set("host",this._host),r.on("response",this._saveCookies.bind(this)),r.on("redirect",this._saveCookies.bind(this)),r.on("redirect",this._attachCookies.bind(this)),this._attachCookies(r),this._setDefaults(r),r}})),_.agent=y,_}));
//# sourceMappingURL=index.js.map
